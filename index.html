<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Oracle - Debug Version</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      #overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #111; color: white; display: flex; flex-direction: column;
        justify-content: center; align-items: center; z-index: 9999; font-family: sans-serif;
      }
      button { padding: 20px 40px; font-size: 20px; cursor: pointer; z-index: 10002; }
      #syncButton {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
        z-index: 10001; padding: 15px 30px; background: #00d4ff; color: black;
        border: none; border-radius: 50px; display: none; font-weight: bold;
      }
      #logger {
        position: fixed; top: 10px; right: 10px; width: 200px; height: 150px;
        background: rgba(0,0,0,0.7); color: lime; font-size: 10px; padding: 5px;
        pointer-events: none; z-index: 10005; font-family: monospace; overflow: hidden;
      }
    </style>
  </head>
  <body>

    <div id="logger">Log: Warte auf Start...</div>

    <div id="overlay">
      <h1>Oracle du Ciel</h1>
      <button id="startButton">SENSUREN AKTIVIEREN & START</button>
    </div>

    <button id="syncButton">POLARIS FIXIEREN</button>

    <a-scene library-logger>
      <a-assets>
        <img id="skyClean" src="stars_clean.jpg">
        <img id="skyLines" src="stars_lines.jpg">
      </a-assets>

      <a-sky id="sky" color="#111"></a-sky>

      <a-entity id="debugDots">
        <a-sphere position="5 0 -10" radius="0.1" color="red"></a-sphere>
        <a-sphere position="-5 2 -10" radius="0.1" color="blue"></a-sphere>
        <a-sphere position="0 -3 -10" radius="0.1" color="yellow"></a-sphere>
      </a-entity>

      <a-entity id="polarstern-anchor" rotation="52.16 70.15 0">
        <a-sphere id="polarstern-sphere" class="interaktiv" position="0 0 -20" radius="0.5" color="#00d4ff" visible="false"></a-sphere>
      </a-entity>

      <a-camera id="mainCam" look-controls="magicWindowTrackingEnabled: true; touchEnabled: true">
        <a-cursor color="#00d4ff"></a-cursor>
      </a-camera>
    </a-scene>

    <script>
      const log = (msg) => {
        const l = document.getElementById('logger');
        l.innerHTML = msg + "<br>" + l.innerHTML;
        console.log(msg);
      };

      const startButton = document.getElementById('startButton');
      const syncBtn = document.getElementById('syncButton');
      const sky = document.querySelector('#sky');
      const camera = document.querySelector('#mainCam');
      let currentAct = 0;

      startButton.addEventListener('click', function() {
        log("Start geklickt...");
        
        // iOS Sensoren-Check
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(state => {
              log("Sensor-Status: " + state);
              if (state === 'granted') startApp();
              else alert("Sensoren wurden abgelehnt!");
            })
            .catch(e => log("Fehler: " + e));
        } else {
          log("Kein iOS-Sensor-Dialog nötig.");
          startApp();
        }
      });

      function startApp() {
        document.getElementById('overlay').style.display = 'none';
        syncBtn.style.display = 'block';
        log("App gestartet. Akt 0 aktiv.");
      }

      syncBtn.addEventListener('click', function() {
        log("Sync gedrückt! Akt: " + currentAct);
        
        // Wir nutzen hier die stabilere Methode über object3D
        let rot = camera.getAttribute('rotation');
        log("Blickwinkel: Y=" + rot.y.toFixed(2));

        let imagePolarisY = -70.15; 
        let targetY = rot.y - imagePolarisY;

        if (currentAct === 0) {
          log("Wechsel zu Akt 1...");
          sky.setAttribute('src', '#skyClean');
          sky.setAttribute('color', '#fff'); // Weiß macht die Textur sichtbar
          document.getElementById('debugDots').setAttribute('visible', 'false');
          syncBtn.innerText = "LINIEN ENTHÜLLEN";
          currentAct = 1;
        } 
        else if (currentAct === 1) {
          log("Wechsel zu Akt 2...");
          sky.setAttribute('src', '#skyLines');
          document.getElementById('polarstern-sphere').setAttribute('visible', 'true');
          syncBtn.innerText = "NEU AUSRICHTEN";
          currentAct = 2;
        }

        // Rotation immer anwenden
        sky.setAttribute('rotation', {x: 0, y: targetY, z: 0});
      });
    </script>
  </body>
</html>
